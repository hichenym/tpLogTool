# é‡æ„æ¨¡å—ä½¿ç”¨æŒ‡å—

## ğŸ“š æ¦‚è¿°

æœ¬æ–‡æ¡£ä»‹ç»å¦‚ä½•ä½¿ç”¨å·²å®Œæˆçš„é‡æ„æ¨¡å—ï¼ŒåŒ…æ‹¬å·¥å…·æ¨¡å—ï¼ˆutils/ï¼‰å’Œè‡ªå®šä¹‰æ§ä»¶æ¨¡å—ï¼ˆwidgets/ï¼‰ã€‚

## ğŸ› ï¸ å·¥å…·æ¨¡å—ï¼ˆutils/ï¼‰

### 1. é…ç½®ç®¡ç†å™¨ï¼ˆconfig.pyï¼‰

#### åŸºæœ¬ä½¿ç”¨
```python
from utils import config_manager, get_account_config, save_account_config

# æ–¹å¼1ï¼šä½¿ç”¨é…ç½®ç®¡ç†å™¨ï¼ˆæ¨èï¼‰
account_config = config_manager.load_account_config()
print(account_config.username)
print(account_config.password)

# ä¿®æ”¹é…ç½®
account_config.username = "new_user"
config_manager.save_account_config(account_config)

# æ–¹å¼2ï¼šä½¿ç”¨å‘åå…¼å®¹å‡½æ•°
env, username, password = get_account_config()
save_account_config('pro', 'user', 'pass')
```

#### åº”ç”¨é…ç½®
```python
# åŠ è½½åº”ç”¨é…ç½®
app_config = config_manager.load_app_config()
print(app_config.export_path)
print(app_config.phone_history)
print(app_config.last_page_index)

# ä¿å­˜åº”ç”¨é…ç½®
app_config.export_path = "C:/exports"
app_config.phone_history.append("13800138000")
config_manager.save_app_config(app_config)
```

### 2. è®¾å¤‡æŸ¥è¯¢APIï¼ˆdevice_query.pyï¼‰

#### åŸºæœ¬æŸ¥è¯¢
```python
from utils import DeviceQuery, wake_device_smart, check_device_online

# åˆå§‹åŒ–æŸ¥è¯¢å¯¹è±¡
query = DeviceQuery('pro', 'username', 'password')

# æ£€æŸ¥åˆå§‹åŒ–æ˜¯å¦æˆåŠŸ
if query.init_error:
    print(f"åˆå§‹åŒ–å¤±è´¥: {query.init_error}")
else:
    # æŸ¥è¯¢è®¾å¤‡ä¿¡æ¯
    info = query.get_device_info(dev_sn="SN123456")
    
    # è·å–è®¾å¤‡å¯†ç 
    password = query.get_cloud_password(dev_id="12345")
    
    # è·å–è®¾å¤‡ç‰ˆæœ¬
    version = query.get_device_version(dev_id="12345")
    
    # è·å–è®¾å¤‡åç§°
    name = query.get_device_name(dev_id="12345")
```

#### è®¾å¤‡å”¤é†’
```python
# æ™ºèƒ½å”¤é†’ï¼ˆæ¨èï¼‰
success = wake_device_smart(
    dev_id="12345",
    sn="SN123456",
    token=query.token,
    max_times=3
)

# æ£€æŸ¥åœ¨çº¿çŠ¶æ€
is_online = check_device_online("SN123456", query.token)
```

### 3. æŒ‰é’®ç®¡ç†å™¨ï¼ˆbutton_manager.pyï¼‰

#### åˆ›å»ºæŒ‰é’®ç»„
```python
from utils import ButtonManager

# åˆ›å»ºæŒ‰é’®ç®¡ç†å™¨
self.btn_manager = ButtonManager()

# åˆ›å»ºä¸»æŒ‰é’®ç»„
self.main_buttons = self.btn_manager.create_group("main")
self.main_buttons.add(
    self.query_btn,
    self.clear_btn,
    self.batch_wake_btn,
    self.select_all_checkbox,
    self.export_btn
)

# åˆ›å»ºå”¤é†’æŒ‰é’®ç»„
self.wake_buttons = self.btn_manager.create_group("wake")
self.wake_buttons.add(self.wake_btn1, self.wake_btn2)
```

#### ä½¿ç”¨æŒ‰é’®ç»„
```python
# ç¦ç”¨æ‰€æœ‰æŒ‰é’®
self.main_buttons.disable()

# ç¦ç”¨å¹¶æ˜¾ç¤ºåŠ è½½æ–‡æœ¬
self.main_buttons.disable("æŸ¥è¯¢ä¸­...")

# å¯ç”¨æ‰€æœ‰æŒ‰é’®
self.main_buttons.enable()

# è®¾ç½®å•ä¸ªæŒ‰é’®æ–‡æœ¬
self.main_buttons.set_text(self.query_btn, "é‡æ–°æŸ¥è¯¢")
```

### 4. æ¶ˆæ¯ç®¡ç†å™¨ï¼ˆmessage_manager.pyï¼‰

#### åˆ›å»ºæ¶ˆæ¯ç®¡ç†å™¨
```python
from utils import MessageManager, MessageType

# åˆ›å»ºæ¶ˆæ¯ç®¡ç†å™¨
self.msg = MessageManager(self.status_bar)
```

#### æ˜¾ç¤ºä¸åŒç±»å‹çš„æ¶ˆæ¯
```python
# æ™®é€šä¿¡æ¯ï¼ˆé»˜è®¤2ç§’ï¼‰
self.msg.info("å°±ç»ª")

# æˆåŠŸæ¶ˆæ¯ï¼ˆé»˜è®¤3ç§’ï¼‰
self.msg.success("æŸ¥è¯¢å®Œæˆ")
self.msg.success(f"å¯¼å‡ºæˆåŠŸï¼š{filename}")

# è­¦å‘Šæ¶ˆæ¯ï¼ˆé»˜è®¤3ç§’ï¼‰
self.msg.warning("è¯·è¾“å…¥è´¦å·")
self.msg.warning("è®¾å¤‡ä¿¡æ¯ä¸å®Œæ•´")

# é”™è¯¯æ¶ˆæ¯ï¼ˆé»˜è®¤5ç§’ï¼‰
self.msg.error("æŸ¥è¯¢å¤±è´¥")
self.msg.error(f"æŸ¥è¯¢å¤±è´¥: {error_msg}")

# è¿›åº¦æ¶ˆæ¯ï¼ˆä¸è‡ªåŠ¨æ¶ˆå¤±ï¼‰
self.msg.progress("æŸ¥è¯¢è¿›åº¦: 10/100")
self.msg.progress(f"å”¤é†’è¿›åº¦: {completed}/{total}")

# è‡ªå®šä¹‰æ˜¾ç¤ºæ—¶é•¿
self.msg.info("è‡ªå®šä¹‰æ¶ˆæ¯", duration=5000)  # 5ç§’

# æ¸…ç©ºæ¶ˆæ¯
self.msg.clear()
```

### 5. æ ·å¼ç®¡ç†å™¨ï¼ˆstyle_manager.pyï¼‰

#### åº”ç”¨æ ·å¼
```python
from utils import StyleManager

# åº”ç”¨é¢„å®šä¹‰æ ·å¼
StyleManager.apply_to_widget(self.menu_btn, "MENU_BUTTON")
StyleManager.apply_to_widget(self.settings_btn, "SETTINGS_BUTTON")
StyleManager.apply_to_widget(self.menu_widget, "MENU_BAR")
StyleManager.apply_to_widget(self.result_table, "TABLE")
StyleManager.apply_to_widget(self.splitter, "SPLITTER")

# è·å–æ ·å¼å­—ç¬¦ä¸²
style = StyleManager.get_style("VERSION_LABEL")
self.version_label.setStyleSheet(style)
```

#### å¯ç”¨æ ·å¼åˆ—è¡¨
- `MENU_BUTTON` - èœå•æŒ‰é’®æ ·å¼
- `SETTINGS_BUTTON` - è®¾ç½®æŒ‰é’®æ ·å¼
- `MENU_BAR` - èœå•æ æ ·å¼
- `TABLE` - è¡¨æ ¼æ ·å¼
- `SPLITTER` - åˆ†éš”å™¨æ ·å¼
- `VERSION_LABEL` - ç‰ˆæœ¬æ ‡ç­¾æ ·å¼

### 6. è¡¨æ ¼å·¥å…·ï¼ˆtable_helper.pyï¼‰

#### åŒå‡»å¤åˆ¶åŠŸèƒ½
```python
from utils import TableHelper

# è®¾ç½®åŒå‡»å¤åˆ¶ï¼ˆæ¨èï¼‰
TableHelper.setup_copy_on_double_click(
    self.result_table,
    status_callback=self.msg.info,  # æ¶ˆæ¯å›è°ƒ
    skip_columns=[0, 9]  # è·³è¿‡é€‰æ‹©åˆ—å’Œæ“ä½œåˆ—
)

# æˆ–è€…æ‰‹åŠ¨è¿æ¥
self.result_table.cellDoubleClicked.connect(
    lambda row, col: TableHelper.copy_cell_on_double_click(
        self.result_table, row, col, self.msg.info, [0, 9]
    )
)
```

#### åˆ—å®½è‡ªåŠ¨è°ƒæ•´
```python
# æŒ‰æ¯”ä¾‹è°ƒæ•´åˆ—å®½
TableHelper.adjust_columns_proportionally(
    self.result_table,
    fixed_columns={0: 50, 9: 140},  # å›ºå®šåˆ—é…ç½®
    available_width=self.result_table.width()
)

# åœ¨çª—å£resizeäº‹ä»¶ä¸­è°ƒç”¨
def resizeEvent(self, event):
    super().resizeEvent(event)
    TableHelper.adjust_columns_proportionally(
        self.result_table,
        fixed_columns={0: 50, 9: 140},
        available_width=self.result_table.width()
    )
```

#### å¯¼å‡ºCSV
```python
# å¯¼å‡ºè¡¨æ ¼åˆ°CSV
try:
    count = TableHelper.export_to_csv(
        self.result_table,
        file_path="export.csv",
        columns={
            1: "è®¾å¤‡åç§°",
            2: "SN",
            3: "ID",
            4: "å¯†ç "
        },
        skip_text=["æŸ¥è¯¢ä¸­...", ""]
    )
    self.msg.success(f"å¯¼å‡ºæˆåŠŸï¼šå…±{count}æ¡æ•°æ®")
except Exception as e:
    self.msg.error(f"å¯¼å‡ºå¤±è´¥ï¼š{str(e)}")
```

### 7. çº¿ç¨‹ç®¡ç†å™¨ï¼ˆthread_manager.pyï¼‰

#### åˆ›å»ºçº¿ç¨‹ç®¡ç†å™¨
```python
from utils import ThreadManager
from utils.workers import QueryThread, WakeThread

# åˆ›å»ºçº¿ç¨‹ç®¡ç†å™¨
self.thread_mgr = ThreadManager()
```

#### ç®¡ç†æŸ¥è¯¢çº¿ç¨‹
```python
# åˆ›å»ºå¹¶æ·»åŠ æŸ¥è¯¢çº¿ç¨‹
query_thread = QueryThread(sn_list, id_list, env, username, password)
query_thread.single_result.connect(self.on_single_result)
query_thread.all_done.connect(self.on_query_complete)
query_thread.progress.connect(self.msg.progress)
query_thread.error.connect(self.msg.error)

# æ·»åŠ åˆ°ç®¡ç†å™¨
self.thread_mgr.add("query", query_thread)
query_thread.start()

# åœæ­¢çº¿ç¨‹
self.thread_mgr.stop("query")

# è·å–çº¿ç¨‹
thread = self.thread_mgr.get("query")
```

#### ç®¡ç†å¤šä¸ªçº¿ç¨‹
```python
# æ·»åŠ å¤šä¸ªçº¿ç¨‹
self.thread_mgr.add("query", query_thread)
self.thread_mgr.add("wake", wake_thread)
self.thread_mgr.add("phone_query", phone_query_thread)

# åœæ­¢æ‰€æœ‰çº¿ç¨‹
self.thread_mgr.stop_all()

# æ¸…ç†å·²å®Œæˆçš„çº¿ç¨‹
self.thread_mgr.cleanup_all()
```

#### åœ¨çª—å£å…³é—­æ—¶æ¸…ç†
```python
def closeEvent(self, event):
    """çª—å£å…³é—­äº‹ä»¶"""
    # åœæ­¢æ‰€æœ‰çº¿ç¨‹
    self.thread_mgr.stop_all(wait_ms=1000)
    event.accept()
```

### 8. å¤šçº¿ç¨‹Workerï¼ˆworkers.pyï¼‰

#### æŸ¥è¯¢çº¿ç¨‹
```python
from utils.workers import QueryThread

# åˆ›å»ºæŸ¥è¯¢çº¿ç¨‹
query_thread = QueryThread(
    sn_list=['SN001', 'SN002'],
    id_list=['ID001', 'ID002'],
    env='pro',
    username='user',
    password='pass',
    max_workers=30
)

# è¿æ¥ä¿¡å·
query_thread.init_success.connect(self.on_query_init_success)
query_thread.single_result.connect(self.on_single_result)
query_thread.all_done.connect(self.on_query_complete)
query_thread.progress.connect(self.on_query_progress)
query_thread.error.connect(self.on_query_error)

# å¯åŠ¨çº¿ç¨‹
query_thread.start()

# åœæ­¢çº¿ç¨‹
query_thread.stop()
```

#### å”¤é†’çº¿ç¨‹
```python
from utils.workers import WakeThread

# åˆ›å»ºå”¤é†’çº¿ç¨‹
wake_thread = WakeThread(
    devices=[('dev_id1', 'sn1'), ('dev_id2', 'sn2')],
    query=query_object,  # å·²åˆå§‹åŒ–çš„DeviceQueryå¯¹è±¡
    max_workers=30
)

# è¿æ¥ä¿¡å·
wake_thread.wake_result.connect(self.on_wake_result)
wake_thread.all_done.connect(self.on_wake_complete)
wake_thread.progress.connect(self.on_wake_progress)
wake_thread.error.connect(self.on_wake_error)

# å¯åŠ¨çº¿ç¨‹
wake_thread.start()
```

#### è´¦å·æŸ¥è¯¢çº¿ç¨‹
```python
from utils.workers import PhoneQueryThread

# åˆ›å»ºè´¦å·æŸ¥è¯¢çº¿ç¨‹
phone_query_thread = PhoneQueryThread(
    phone='13800138000',
    env='pro',
    username='user',
    password='pass'
)

# è¿æ¥ä¿¡å·
phone_query_thread.progress.connect(self.on_phone_query_progress)
phone_query_thread.error.connect(self.on_phone_query_error)
phone_query_thread.success.connect(self.on_phone_query_success)

# å¯åŠ¨çº¿ç¨‹
phone_query_thread.start()
```

## ğŸ¨ è‡ªå®šä¹‰æ§ä»¶æ¨¡å—ï¼ˆwidgets/ï¼‰

### 1. ClickableLabelï¼ˆå¯ç‚¹å‡»æ ‡ç­¾ï¼‰

```python
from widgets import ClickableLabel

# åˆ›å»ºå¯ç‚¹å‡»æ ‡ç­¾
self.version_label = ClickableLabel("  ")
self.version_label.setStyleSheet("color: gray;")

# è®¾ç½®ç‚¹å‡»å›è°ƒ
self.version_label.clicked = self.on_version_clicked

def on_version_clicked(self):
    """ç‰ˆæœ¬æ ‡ç­¾ç‚¹å‡»äº‹ä»¶"""
    self.version_label.setText(get_version_string())
    # 1ç§’åéšè—
    QTimer.singleShot(1000, lambda: self.version_label.setText("  "))
```

### 2. PlainTextEditï¼ˆçº¯æ–‡æœ¬è¾“å…¥æ¡†ï¼‰

```python
from widgets import PlainTextEdit

# åˆ›å»ºçº¯æ–‡æœ¬è¾“å…¥æ¡†
self.sn_input = PlainTextEdit()
self.sn_input.setPlaceholderText("è¯·è¾“å…¥è®¾å¤‡SNï¼Œæ¯è¡Œä¸€ä¸ª...")

# ç²˜è´´æ—¶è‡ªåŠ¨æ¸…é™¤æ ¼å¼
# æ— éœ€é¢å¤–ä»£ç ï¼Œæ§ä»¶è‡ªåŠ¨å¤„ç†
```

### 3. ClickableLineEditï¼ˆå¯åŒå‡»æ‰“å¼€ç›®å½•ï¼‰

```python
from widgets import ClickableLineEdit

# åˆ›å»ºå¯åŒå‡»æ‰“å¼€ç›®å½•çš„è¾“å…¥æ¡†
self.export_path_input = ClickableLineEdit()
self.export_path_input.setPlaceholderText("åŒå‡»å¯æ‰“å¼€ç›®å½•...")
self.export_path_input.setReadOnly(True)

# è®¾ç½®è·¯å¾„
self.export_path_input.setText("C:/exports")

# åŒå‡»è‡ªåŠ¨æ‰“å¼€ç›®å½•
# æ— éœ€é¢å¤–ä»£ç ï¼Œæ§ä»¶è‡ªåŠ¨å¤„ç†
```

### 4. SettingsDialogï¼ˆè®¾ç½®å¯¹è¯æ¡†ï¼‰

```python
from widgets import SettingsDialog

# æ‰“å¼€è®¾ç½®å¯¹è¯æ¡†
def on_settings_clicked(self):
    dialog = SettingsDialog(self)
    if dialog.exec_() == QDialog.Accepted:
        # ç”¨æˆ·ç‚¹å‡»äº†ä¿å­˜
        print("é…ç½®å·²ä¿å­˜")
```

## ğŸ“ å®Œæ•´ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šç®€åŒ–çš„æŸ¥è¯¢åŠŸèƒ½

```python
from PyQt5.QtWidgets import QMainWindow, QPushButton, QTableWidget, QStatusBar
from utils import (
    ButtonManager, MessageManager, ThreadManager,
    get_account_config, TableHelper
)
from utils.workers import QueryThread

class MyWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        
        # åˆ›å»ºç®¡ç†å™¨
        self.btn_manager = ButtonManager()
        self.msg = MessageManager(self.statusBar())
        self.thread_mgr = ThreadManager()
        
        # åˆ›å»ºæŒ‰é’®ç»„
        self.main_buttons = self.btn_manager.create_group("main")
        self.main_buttons.add(self.query_btn, self.clear_btn)
        
        # è®¾ç½®è¡¨æ ¼åŒå‡»å¤åˆ¶
        TableHelper.setup_copy_on_double_click(
            self.result_table,
            status_callback=self.msg.info,
            skip_columns=[0]
        )
    
    def on_query(self):
        """æŸ¥è¯¢æŒ‰é’®ç‚¹å‡»"""
        # ç¦ç”¨æŒ‰é’®
        self.main_buttons.disable("æŸ¥è¯¢ä¸­...")
        
        # è·å–é…ç½®
        env, username, password = get_account_config()
        
        # åˆ›å»ºæŸ¥è¯¢çº¿ç¨‹
        query_thread = QueryThread(
            sn_list=['SN001'],
            id_list=[],
            env=env,
            username=username,
            password=password
        )
        
        # è¿æ¥ä¿¡å·
        query_thread.single_result.connect(self.on_single_result)
        query_thread.all_done.connect(self.on_query_complete)
        query_thread.progress.connect(self.msg.progress)
        query_thread.error.connect(self.msg.error)
        
        # æ·»åŠ åˆ°ç®¡ç†å™¨å¹¶å¯åŠ¨
        self.thread_mgr.add("query", query_thread)
        query_thread.start()
    
    def on_query_complete(self):
        """æŸ¥è¯¢å®Œæˆ"""
        self.main_buttons.enable()
        self.msg.success("æŸ¥è¯¢å®Œæˆ")
    
    def closeEvent(self, event):
        """çª—å£å…³é—­"""
        self.thread_mgr.stop_all()
        event.accept()
```

### ç¤ºä¾‹2ï¼šç®€åŒ–çš„å¯¼å‡ºåŠŸèƒ½

```python
from PyQt5.QtWidgets import QFileDialog
from utils import TableHelper, MessageManager
from datetime import datetime

class MyWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        self.msg = MessageManager(self.statusBar())
    
    def on_export_csv(self):
        """å¯¼å‡ºCSV"""
        if self.result_table.rowCount() == 0:
            self.msg.warning("æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®")
            return
        
        # ç”Ÿæˆé»˜è®¤æ–‡ä»¶å
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        default_filename = f"è®¾å¤‡ä¿¡æ¯_{timestamp}.csv"
        
        # é€‰æ‹©ä¿å­˜ä½ç½®
        file_path, _ = QFileDialog.getSaveFileName(
            self,
            "ä¿å­˜CSVæ–‡ä»¶",
            default_filename,
            "CSVæ–‡ä»¶ (*.csv)"
        )
        
        if not file_path:
            return
        
        try:
            # å¯¼å‡º
            count = TableHelper.export_to_csv(
                self.result_table,
                file_path=file_path,
                columns={
                    1: "è®¾å¤‡åç§°",
                    2: "SN",
                    3: "ID",
                    4: "å¯†ç "
                },
                skip_text=["æŸ¥è¯¢ä¸­..."]
            )
            
            filename = os.path.basename(file_path)
            self.msg.success(f"å¯¼å‡ºæˆåŠŸï¼š{filename}ï¼ˆå…±{count}æ¡æ•°æ®ï¼‰")
        except Exception as e:
            self.msg.error(f"å¯¼å‡ºå¤±è´¥ï¼š{str(e)}")
```

## ğŸ¯ æœ€ä½³å®è·µ

### 1. ç»Ÿä¸€ä½¿ç”¨ç®¡ç†å™¨
```python
# âœ… æ¨è
self.main_buttons.disable("æŸ¥è¯¢ä¸­...")
self.msg.success("æŸ¥è¯¢å®Œæˆ")

# âŒ ä¸æ¨è
self.query_btn.setEnabled(False)
self.query_btn.setText("æŸ¥è¯¢ä¸­...")
self.status_bar.showMessage("âœ“ æŸ¥è¯¢å®Œæˆ", 3000)
```

### 2. ç»Ÿä¸€ä½¿ç”¨æ ·å¼ç®¡ç†å™¨
```python
# âœ… æ¨è
StyleManager.apply_to_widget(self.menu_btn, "MENU_BUTTON")

# âŒ ä¸æ¨è
self.menu_btn.setStyleSheet("""
    QPushButton {
        border: none;
        ...
    }
""")
```

### 3. ç»Ÿä¸€ä½¿ç”¨çº¿ç¨‹ç®¡ç†å™¨
```python
# âœ… æ¨è
self.thread_mgr.add("query", query_thread)
self.thread_mgr.stop_all()

# âŒ ä¸æ¨è
self.query_thread = query_thread
if self.query_thread and self.query_thread.isRunning():
    self.query_thread.stop()
    self.query_thread.wait()
```

### 4. ç»Ÿä¸€ä½¿ç”¨è¡¨æ ¼å·¥å…·
```python
# âœ… æ¨è
TableHelper.setup_copy_on_double_click(
    self.result_table,
    status_callback=self.msg.info,
    skip_columns=[0, 9]
)

# âŒ ä¸æ¨è
def on_cell_double_clicked(self, row, column):
    if column == 0 or column == 9:
        return
    item = self.result_table.item(row, column)
    if item:
        text = item.text()
        ...
```

## ğŸ“š å‚è€ƒèµ„æ–™

- [ä»£ç é‡æ„è¯´æ˜.md](./ä»£ç é‡æ„è¯´æ˜.md) - è¯¦ç»†çš„é‡æ„è¯´æ˜
- [é‡æ„è¿›åº¦æŠ¥å‘Š.md](./é‡æ„è¿›åº¦æŠ¥å‘Š.md) - å½“å‰è¿›åº¦æŠ¥å‘Š
- [Python Type Hints](https://docs.python.org/3/library/typing.html) - ç±»å‹æç¤ºæ–‡æ¡£
- [PyQt5 Documentation](https://www.riverbankcomputing.com/static/Docs/PyQt5/) - PyQt5å®˜æ–¹æ–‡æ¡£

---

*æ–‡æ¡£åˆ›å»ºæ—¶é—´ï¼š2025-01-21*
*ç‰ˆæœ¬ï¼šv1.0*
