# 设置功能使用指南

## 界面位置

设置按钮位于程序主界面的菜单栏最右侧，显示为齿轮图标：

```
┌────────────────────────────────────────┐
│ [状态] [设备]                      [⚙️] │
└────────────────────────────────────────┘
```

## 打开设置

点击菜单栏右侧的 **"⚙️"图标按钮**，会弹出设置对话框。

## 设置对话框

### 界面布局

```
┌─────────────────────────────────────┐
│  账号密码设置                    [×] │
├─────────────────────────────────────┤
│                                      │
│  □ 使用默认账号                      │
│                                      │
│  账号：  [____________________]      │
│                                      │
│  密码：  [●●●●●●●●●●●●●●●●●●]      │
│         □ 显示密码                   │
│                                      │
│  ─────────────────────────────────   │
│                                      │
│         [测试连接]  [保存]  [取消]   │
│                                      │
└─────────────────────────────────────┘
```

### 字段说明

1. **使用默认账号**
   - 勾选：使用内置的默认账号密码
   - 账号和密码显示为 `**********`
   - 输入框不可编辑
   - "显示密码"复选框禁用

2. **账号**
   - 取消勾选"使用默认账号"后可编辑
   - 正常显示输入的文本
   - 必填项

3. **密码**
   - 取消勾选"使用默认账号"后可编辑
   - 使用 `●` 隐藏显示
   - 必填项

4. **显示密码**
   - 勾选后可以看到密码明文
   - 仅在取消"使用默认账号"后可用
   - 不影响账号的显示

## 操作步骤

### 使用默认账号

1. 点击菜单栏的"⚙️"图标按钮
2. 确保"使用默认账号"已勾选
3. 点击"保存"按钮

### 使用自定义账号

1. 点击菜单栏的"⚙️"图标按钮
2. 取消勾选"使用默认账号"
3. 输入账号
4. 输入密码
5. （可选）点击"测试连接"验证账号是否有效
6. 点击"保存"按钮

### 测试连接

点击"测试连接"按钮后：

- 程序会尝试使用当前配置的账号密码登录
- 测试过程中按钮显示"测试中..."
- 测试结果会弹出提示框：
  - ✅ **连接成功**：账号密码正确，可以正常使用
  - ❌ **连接失败**：显示具体错误信息

## 配置存储

### 存储位置

配置保存在Windows注册表中：
```
HKEY_CURRENT_USER\Software\TPQueryTool
```

### 存储内容

| 字段名 | 说明 | 示例 |
|--------|------|------|
| account_env | 环境（固定） | pro |
| account_username | 账号 | yinjia |
| account_password | 密码（Base64编码） | WWp0ZXN0MTIzNDU2Lg== |

### 安全性

- 密码使用Base64编码存储，不是明文
- 配置保存在当前用户的注册表中
- 不同Windows用户的配置互不影响

## 默认配置

如果注册表中没有配置，程序会使用以下默认值：

| 字段 | 默认值 |
|------|--------|
| 环境 | 生产环境（pro） |
| 账号 | yinjia |
| 密码 | Yjtest123456. |

## 常见问题

### Q1: 修改配置后需要重启程序吗？

**A:** 不需要。保存配置后，下次查询时会自动使用新配置。

### Q2: 测试连接失败怎么办？

**A:** 检查以下几点：
1. 账号密码是否正确
2. 网络连接是否正常
3. 如果使用默认账号，可能默认账号已失效，需要使用自定义账号

### Q3: 如何恢复默认配置？

**A:** 在设置界面中勾选"使用默认账号"，然后点击"保存"即可。

### Q4: 配置会丢失吗？

**A:** 配置保存在注册表中，除非手动删除或重装系统，否则不会丢失。

### Q5: 可以配置多个账号吗？

**A:** 目前只支持配置一个账号。如需切换账号，在设置界面修改后保存即可。

### Q6: 密码安全吗？

**A:** 密码使用Base64编码存储在注册表中，不是明文。但Base64不是加密，只是编码，建议：
- 不要在共享电脑上保存敏感账号
- 定期更换密码
- 使用专用测试账号

### Q7: 为什么没有环境选择？

**A:** 为了简化配置，程序固定使用生产环境。

## 使用技巧

### 技巧1：先测试再保存

在保存配置前，建议先点击"测试连接"验证账号是否有效，避免保存错误配置。

### 技巧2：显示密码确认

输入密码后，可以勾选"显示密码"确认输入是否正确，特别是包含特殊字符的密码。

### 技巧3：默认账号快速切换

如果需要在默认账号和自定义账号之间切换，只需勾选或取消"使用默认账号"复选框即可。

## 故障排除

### 问题1：点击设置按钮没反应

**可能原因：**
- 程序正在执行其他操作（查询、唤醒等）

**解决方法：**
- 等待当前操作完成后再打开设置

### 问题2：保存配置失败

**可能原因：**
- 注册表权限不足
- 系统限制

**解决方法：**
- 以管理员身份运行程序
- 检查系统安全策略

### 问题3：配置保存后不生效

**可能原因：**
- 使用了缓存的Token

**解决方法：**
- 清除Token缓存（重新登录）
- 或等待Token过期（2小时）后自动刷新

## 技术说明

### 配置读取流程

```
1. 程序启动
2. 调用 get_account_config()
3. 从注册表读取配置
4. 如果没有配置，使用默认值
5. 返回 (env, username, password)
```

### 配置保存流程

```
1. 用户点击"保存"按钮
2. 调用 save_account_config(env, username, password)
3. 密码Base64编码
4. 写入注册表
5. 返回保存结果
```

### 相关代码

- `get_account_config()`: 读取配置（main.py 第54-68行）
- `save_account_config()`: 保存配置（main.py 第70-78行）
- `SettingsDialog`: 设置对话框类（main.py 第96-240行）

## 更新记录

| 版本 | 日期 | 更新内容 |
|------|------|----------|
| v1.1.1 | 2026-01-17 | Bug修复版本：修复代码重复定义、改进异常处理、增强线程清理 |
| v1.1.0 | 2026-01-17 | 首次发布设置功能，支持默认账号和自定义账号 |
