# 设置功能使用指南

## 界面位置

设置按钮位于程序主界面的菜单栏最右侧，显示为齿轮图标：

```
┌────────────────────────────────────────┐
│ [设备] [固件]                      [⚙️] │
└────────────────────────────────────────┘
```

## 打开设置

点击菜单栏右侧的 **"⚙️"图标按钮**，会弹出设置对话框。

## 设置对话框

### 界面布局

```
┌─────────────────────────────────────┐
│  账号密码设置                    [×] │
├─────────────────────────────────────┤
│  [运维账号] [固件账号]              │
├─────────────────────────────────────┤
│                                      │
│  账号：  [____________________]      │
│                                      │
│  密码：  [●●●●●●●●●●●●●●●●●●]      │
│         □ 显示密码                   │
│                                      │
│  ─────────────────────────────────   │
│                                      │
│         [测试连接]  [✓]  [✗]        │
│                                      │
└─────────────────────────────────────┘
```

### 标签页说明

设置对话框使用标签页分离两个系统的账号配置：

#### 1. 运维账号标签页
- **用途**：设备查询、唤醒、重启等运维功能
- **账号**：输入运维系统账号
- **密码**：输入运维系统密码（使用 `●` 隐藏显示）
- **显示密码**：勾选后可以看到密码明文

#### 2. 固件账号标签页
- **用途**：固件查询、新增、修改、删除等固件管理功能
- **账号**：输入固件系统账号
- **密码**：输入固件系统密码（使用 `●` 隐藏显示）
- **显示密码**：勾选后可以看到密码明文

### 标签页切换效果
- **未选中**：背景色与页面一致
- **选中**：背景色高亮显示（与表格选中行颜色一致）
- **悬停**：背景色变化提示可点击

## 操作步骤

### 配置运维账号

1. 点击菜单栏的"⚙️"图标按钮
2. 确保在"运维账号"标签页
3. 输入运维系统账号
4. 输入运维系统密码
5. （可选）点击"测试连接"验证账号是否有效
6. 点击"✓"按钮保存

### 配置固件账号

1. 点击菜单栏的"⚙️"图标按钮
2. 切换到"固件账号"标签页
3. 输入固件系统账号
4. 输入固件系统密码
5. （可选）点击"测试连接"验证账号是否有效
6. 点击"✓"按钮保存

### 灵活配置

程序支持灵活的配置方式：
- ✅ 可以两个账号都不填（首次使用）
- ✅ 可以只填运维账号（只用设备查询功能）
- ✅ 可以只填固件账号（只用固件管理功能）
- ✅ 可以两个都填（使用全部功能）
- ⚠️ 单个系统的账号和密码必须同时填写或同时为空

### 测试连接

点击"测试连接"按钮后：

- 程序会根据当前选中的标签页测试对应系统的账号
- 在"运维账号"标签页：测试运维系统连接
- 在"固件账号"标签页：测试固件系统连接
- 测试过程中按钮显示"测试中..."
- 测试结果显示在状态栏：
  - ✅ **连接成功**：账号密码正确，可以正常使用
  - ❌ **连接失败**：显示具体错误信息

## 配置存储

### 存储位置

配置保存在Windows注册表中：
```
HKEY_CURRENT_USER\Software\TPQueryTool
```

### 存储内容

**运维账号：**
| 字段名 | 说明 | 示例 |
|--------|------|------|
| account_env | 环境（固定） | pro |
| account_username | 账号 | admin |
| account_password | 密码（Base64编码） | YWRtaW4xMjM0NTY= |

**固件账号：**
| 字段名 | 说明 | 示例 |
|--------|------|------|
| firmware_username | 账号 | firmware_user |
| firmware_password | 密码（Base64编码） | ZmlybXdhcmUxMjM0NTY= |

### 安全性

- 密码使用Base64编码存储，不是明文
- 配置保存在当前用户的注册表中
- 不同Windows用户的配置互不影响

## 未配置提示

### 运维账号未配置
当查询设备时，如果运维账号未配置，会弹出提示：
```
┌─────────────────────────────────┐
│  提示                        [×] │
├─────────────────────────────────┤
│  检测到运维系统账号信息未配置， │
│  点击OK前往配置。               │
│                                  │
│              [✓]  [✗]           │
└─────────────────────────────────┘
```
点击✓会自动打开设置对话框并切换到"运维账号"标签页。

### 固件账号未配置
当查询或新增固件时，如果固件账号未配置，会弹出提示：
```
┌─────────────────────────────────┐
│  提示                        [×] │
├─────────────────────────────────┤
│  检测到固件系统账号信息未配置， │
│  点击OK前往配置。               │
│                                  │
│              [✓]  [✗]           │
└─────────────────────────────────┘
```
点击✓会自动打开设置对话框并切换到"固件账号"标签页。

## 常见问题

### Q1: 修改配置后需要重启程序吗？

**A:** 不需要。保存配置后，下次查询时会自动使用新配置。

### Q2: 测试连接失败怎么办？

**A:** 检查以下几点：
1. 账号密码是否正确
2. 网络连接是否正常
3. 确认在正确的标签页测试对应系统的账号

### Q3: 可以只配置一个系统的账号吗？

**A:** 可以。您可以根据需要只配置运维账号或只配置固件账号，也可以两个都配置。

### Q4: 配置会丢失吗？

**A:** 配置保存在注册表中，除非手动删除或重装系统，否则不会丢失。

### Q5: 两个系统可以使用相同的账号吗？

**A:** 可以，但通常两个系统使用不同的账号体系。

### Q6: 密码安全吗？

**A:** 密码使用Base64编码存储在注册表中，不是明文。但Base64不是加密，只是编码，建议：
- 不要在共享电脑上保存敏感账号
- 定期更换密码
- 使用专用测试账号

### Q7: 为什么没有环境选择？

**A:** 为了简化配置，程序固定使用生产环境。

## 使用技巧

### 技巧1：先测试再保存

在保存配置前，建议先点击"测试连接"验证账号是否有效，避免保存错误配置。

### 技巧2：显示密码确认

输入密码后，可以勾选"显示密码"确认输入是否正确，特别是包含特殊字符的密码。

### 技巧3：标签页快速切换

使用鼠标点击标签页标题可以快速切换，选中的标签页会高亮显示。

### 技巧4：按需配置

如果只使用设备查询功能，只需配置运维账号；如果只使用固件管理功能，只需配置固件账号。

## 故障排除

### 问题1：点击设置按钮没反应

**可能原因：**
- 程序正在执行其他操作（查询、唤醒等）

**解决方法：**
- 等待当前操作完成后再打开设置

### 问题2：保存配置失败

**可能原因：**
- 注册表权限不足
- 系统限制

**解决方法：**
- 以管理员身份运行程序
- 检查系统安全策略

### 问题3：配置保存后不生效

**可能原因：**
- 使用了缓存的Token或Session

**解决方法：**
- 清除缓存（重新登录）
- 或等待缓存过期（2小时）后自动刷新

## 技术说明

### 配置读取流程

```
1. 程序启动
2. 调用 get_account_config() / get_firmware_account_config()
3. 从注册表读取配置
4. 如果没有配置，返回空值
5. 使用功能时检查配置，未配置则提示
```

### 配置保存流程

```
1. 用户点击"✓"按钮
2. 验证输入（账号密码必须同时填写或同时为空）
3. 调用 save_account_config() / save_firmware_account_config()
4. 密码Base64编码
5. 写入注册表
6. 返回保存结果
```

### 相关代码

- 配置管理：`query_tool/utils/config.py`
- 设置对话框：`query_tool/widgets/custom_widgets.py`
- 固件API：`query_tool/utils/firmware_api.py`

## 更新记录

| 版本 | 日期 | 更新内容 |
|------|------|----------|
| v1.2.0 | 2026-02-07 | 新增固件账号独立配置，使用标签页分离，支持灵活配置 |
| v1.1.1 | 2026-01-17 | Bug修复版本：修复代码重复定义、改进异常处理、增强线程清理 |
| v1.1.0 | 2026-01-17 | 首次发布设置功能，支持默认账号和自定义账号 |
