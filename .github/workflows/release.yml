name: Build and Release

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ v3.0.0, v3.0.1 ç­‰æ ‡ç­¾æ—¶è§¦å‘

jobs:
  build:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Extract version from tag
        id: version
        shell: bash
        run: |
          # ä» tag æå–ç‰ˆæœ¬å· (v3.0.0 -> 3.0.0)
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
      
      - name: Update version.py
        shell: bash
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
          BUILD_DATE=$(date +%Y%m%d)
          
          # æ›´æ–° version.py
          sed -i "s/VERSION_MAJOR = .*/VERSION_MAJOR = $MAJOR/" query_tool/version.py
          sed -i "s/VERSION_MINOR = .*/VERSION_MINOR = $MINOR/" query_tool/version.py
          sed -i "s/VERSION_PATCH = .*/VERSION_PATCH = $PATCH/" query_tool/version.py
          sed -i "s/BUILD_DATE = \".*\"/BUILD_DATE = \"$BUILD_DATE\"/" query_tool/version.py
          
          echo "Updated version.py to V$VERSION ($BUILD_DATE)"
      
      - name: Build executable
        run: |
          pyinstaller -F -w `
            -i ./resources/icons/app/logo.ico `
            --name "æŸ¥è¯¢å·¥å…·" `
            run.py `
            --noconsole `
            --hidden-import=ddddocr `
            --hidden-import=onnxruntime `
            --hidden-import=cv2 `
            --hidden-import=numpy `
            --collect-all=ddddocr `
            --collect-binaries=onnxruntime `
            --collect-data=onnxruntime
      
      - name: Get file size
        id: filesize
        shell: bash
        run: |
          SIZE=$(stat -c%s "dist/æŸ¥è¯¢å·¥å…·.exe" 2>/dev/null || stat -f%z "dist/æŸ¥è¯¢å·¥å…·.exe")
          SIZE_MB=$(echo "scale=2; $SIZE / 1048576" | bc)
          echo "size_mb=$SIZE_MB" >> $GITHUB_OUTPUT
          echo "File size: ${SIZE_MB} MB"
      
      - name: Extract changelog from version.py
        id: changelog
        shell: bash
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          # ä» version.py æå–å¯¹åº”ç‰ˆæœ¬çš„æ›´æ–°æ—¥å¿—
          python << 'PYTHON_SCRIPT'
          import re
          import sys
          
          version = "${{ steps.version.outputs.version }}"
          
          # è¯»å– version.py
          with open('query_tool/version.py', 'r', encoding='utf-8') as f:
              content = f.read()
          
          # æå– VERSION_HISTORY
          match = re.search(r'VERSION_HISTORY = """(.*?)"""', content, re.DOTALL)
          if not match:
              print("ERROR: Could not find VERSION_HISTORY", file=sys.stderr)
              sys.exit(1)
          
          history = match.group(1)
          
          # æå–å½“å‰ç‰ˆæœ¬çš„æ›´æ–°æ—¥å¿—
          # åŒ¹é…æ ¼å¼: V3.0.0 (20260207) æˆ– v3.0.0 (20260207)
          version_pattern = rf'[Vv]{re.escape(version)}\s*\([^)]+\)(.*?)(?=[Vv]\d+\.\d+\.\d+|\Z)'
          version_match = re.search(version_pattern, history, re.DOTALL)
          
          if version_match:
              changelog = version_match.group(1).strip()
              # ç§»é™¤å¼€å¤´çš„æ¢è¡Œå’Œç©ºç™½
              changelog = changelog.strip()
              print(f"Found changelog for version {version}")
          else:
              changelog = f"V{version} ç‰ˆæœ¬æ›´æ–°\n\nè¯·æŸ¥çœ‹ query_tool/version.py ä¸­çš„ VERSION_HISTORY è·å–è¯¦ç»†ä¿¡æ¯ã€‚"
              print(f"WARNING: Could not find changelog for version {version}, using default", file=sys.stderr)
          
          # ä¿å­˜åˆ°æ–‡ä»¶ï¼ˆç”¨äºåç»­æ­¥éª¤ï¼‰
          with open('CHANGELOG.txt', 'w', encoding='utf-8') as f:
              f.write(changelog)
          
          print("Changelog extracted successfully")
          PYTHON_SCRIPT
          
          # è¯»å–æå–çš„æ›´æ–°æ—¥å¿—
          if [ -f CHANGELOG.txt ]; then
            echo "changelog_found=true" >> $GITHUB_OUTPUT
          else
            echo "changelog_found=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Generate version.json
        shell: bash
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          BUILD_DATE=$(date +%Y%m%d)
          FILE_SIZE="${{ steps.filesize.outputs.size_mb }}"
          
          # ä» CHANGELOG.txt è¯»å–æ›´æ–°æ—¥å¿—å¹¶è½¬æ¢ä¸º JSON æ•°ç»„
          if [ -f CHANGELOG.txt ]; then
            # è¯»å–æ›´æ–°æ—¥å¿—ï¼Œæå–ä¸»è¦åŠŸèƒ½ç‚¹ï¼ˆä»¥ - æˆ– * å¼€å¤´çš„è¡Œï¼‰
            CHANGELOG_ITEMS=$(grep -E '^\s*[-*]' CHANGELOG.txt | sed 's/^\s*[-*]\s*//' | head -10 | python -c "import sys, json; print(json.dumps([line.strip() for line in sys.stdin if line.strip()]))")
          else
            CHANGELOG_ITEMS='["è¯·æŸ¥çœ‹ Release é¡µé¢è·å–å®Œæ•´æ›´æ–°æ—¥å¿—"]'
          fi
          
          cat > version.json << EOF
          {
            "version": "$VERSION",
            "build_date": "$BUILD_DATE",
            "download_url": "https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/æŸ¥è¯¢å·¥å…·.exe",
            "file_size_mb": $FILE_SIZE,
            "release_notes_url": "https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }}",
            "min_version": "3.0.0",
            "changelog": $CHANGELOG_ITEMS
          }
          EOF
          
          echo "Generated version.json:"
          cat version.json
      
      - name: Generate Release Notes
        shell: bash
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          BUILD_DATE=$(date +%Y-%m-%d)
          FILE_SIZE="${{ steps.filesize.outputs.size_mb }}"
          
          # åˆ›å»º Release è¯´æ˜æ–‡ä»¶
          cat > RELEASE_NOTES.md << EOF
          ## ğŸ‰ æŸ¥è¯¢å·¥å…· V${VERSION}
          
          **ç¼–è¯‘æ—¥æœŸ**: ${BUILD_DATE}
          **æ–‡ä»¶å¤§å°**: ${FILE_SIZE} MB
          
          ### ğŸ“¦ ä¸‹è½½
          - [æŸ¥è¯¢å·¥å…·.exe](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/æŸ¥è¯¢å·¥å…·.exe)
          - [version.json](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/version.json)
          
          ### ğŸ“ æ›´æ–°è¯´æ˜
          
          EOF
          
          # æ·»åŠ ä» version.py æå–çš„æ›´æ–°æ—¥å¿—
          if [ -f CHANGELOG.txt ]; then
            cat CHANGELOG.txt >> RELEASE_NOTES.md
          else
            echo "è¯·æŸ¥çœ‹é¡¹ç›® README æˆ– query_tool/version.py ä¸­çš„ç‰ˆæœ¬å†å²ã€‚" >> RELEASE_NOTES.md
          fi
          
          # æ·»åŠ ä½¿ç”¨è¯´æ˜
          cat >> RELEASE_NOTES.md << 'EOF'
          
          ### ğŸš€ ä½¿ç”¨æ–¹æ³•
          1. ä¸‹è½½ `æŸ¥è¯¢å·¥å…·.exe`
          2. ç›´æ¥è¿è¡Œï¼ˆæ— éœ€å®‰è£…ï¼‰
          3. é¦–æ¬¡è¿è¡Œè¯·é…ç½®è´¦å·ä¿¡æ¯
          
          ### ğŸ“š æ–‡æ¡£
          - [å¿«é€Ÿå¼€å§‹æŒ‡å—](https://github.com/${{ github.repository }}/blob/main/docs/quick-start.md)
          - [å®Œæ•´æ–‡æ¡£](https://github.com/${{ github.repository }}/blob/main/docs/README.md)
          
          ---
          *æ­¤ç‰ˆæœ¬ç”± GitHub Actions è‡ªåŠ¨æ„å»ºå’Œå‘å¸ƒ*
          EOF
          
          echo "Generated Release Notes:"
          cat RELEASE_NOTES.md
      
      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/æŸ¥è¯¢å·¥å…·.exe
            version.json
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Commit version.json to repository
        shell: bash
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add version.json
          git commit -m "chore: update version.json for ${{ steps.version.outputs.tag }}" || echo "No changes to commit"
          git push origin HEAD:main || echo "Failed to push, but release is created"
