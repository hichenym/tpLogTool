name: Build and Release

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ v3.0.0, v3.0.1 ç­‰æ ‡ç­¾æ—¶è§¦å‘

jobs:
  build:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          echo "Installing dependencies from requirements.txt..."
          pip install -r requirements.txt --no-cache-dir -v
        continue-on-error: false
      
      - name: Extract version from tag
        id: version
        shell: pwsh
        run: |
          # ä» tag æå–ç‰ˆæœ¬å· (v3.0.0 -> 3.0.0)
          $tag = "${{ github.ref }}"
          $version = $tag -replace 'refs/tags/v', ''
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "tag=$($tag -replace 'refs/tags/', '')" >> $env:GITHUB_OUTPUT
          Write-Host "Version: $version"
      
      - name: Update version.py
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $parts = $version -split '\.'
          $major = $parts[0]
          $minor = $parts[1]
          $patch = $parts[2]
          $buildDate = Get-Date -Format "yyyyMMdd"
          
          # è¯»å–æ–‡ä»¶
          $content = Get-Content "query_tool/version.py" -Raw -Encoding UTF8
          
          # æ›´æ–°ç‰ˆæœ¬å·
          $content = $content -replace 'VERSION_MAJOR = \d+', "VERSION_MAJOR = $major"
          $content = $content -replace 'VERSION_MINOR = \d+', "VERSION_MINOR = $minor"
          $content = $content -replace 'VERSION_PATCH = \d+', "VERSION_PATCH = $patch"
          $content = $content -replace 'BUILD_DATE = "\d+"', "BUILD_DATE = `"$buildDate`""
          
          # å†™å›æ–‡ä»¶
          $content | Set-Content "query_tool/version.py" -Encoding UTF8 -NoNewline
          
          Write-Host "Updated version.py to V$version ($buildDate)"
      
      - name: Build executable
        run: |
          pyinstaller -F -w `
            -i ./resources/icons/app/logo.ico `
            --name "æŸ¥è¯¢å·¥å…·" `
            run.py `
            --noconsole `
            --hidden-import=ddddocr `
            --hidden-import=onnxruntime `
            --hidden-import=cv2 `
            --hidden-import=numpy `
            --collect-all=ddddocr `
            --collect-binaries=onnxruntime `
            --collect-data=onnxruntime
      
      - name: Get file size
        id: filesize
        shell: pwsh
        run: |
          $file = "dist/æŸ¥è¯¢å·¥å…·.exe"
          $sizeBytes = (Get-Item $file).Length
          $sizeMB = [math]::Round($sizeBytes / 1MB, 2)
          echo "size_mb=$sizeMB" >> $env:GITHUB_OUTPUT
          Write-Host "File size: $sizeMB MB"
      
      - name: Extract changelog from version.py
        id: changelog
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          
          # ä½¿ç”¨ Python æå–æ›´æ–°æ—¥å¿—
          python -c @"
          import re
          import sys
          
          version = '$version'
          
          # è¯»å– version.py
          with open('query_tool/version.py', 'r', encoding='utf-8') as f:
              content = f.read()
          
          # æå– VERSION_HISTORY
          match = re.search(r'VERSION_HISTORY = \"\"\"(.*?)\"\"\"', content, re.DOTALL)
          if not match:
              print('ERROR: Could not find VERSION_HISTORY', file=sys.stderr)
              sys.exit(1)
          
          history = match.group(1)
          
          # æå–å½“å‰ç‰ˆæœ¬çš„æ›´æ–°æ—¥å¿—
          version_pattern = rf'[Vv]{re.escape(version)}\s*\([^)]+\)(.*?)(?=[Vv]\d+\.\d+\.\d+|\Z)'
          version_match = re.search(version_pattern, history, re.DOTALL)
          
          if version_match:
              changelog = version_match.group(1).strip()
              print(f'Found changelog for version {version}')
          else:
              changelog = f'V{version} ç‰ˆæœ¬æ›´æ–°\n\nè¯·æŸ¥çœ‹ query_tool/version.py ä¸­çš„ VERSION_HISTORY è·å–è¯¦ç»†ä¿¡æ¯ã€‚'
              print(f'WARNING: Could not find changelog for version {version}, using default', file=sys.stderr)
          
          # ä¿å­˜åˆ°æ–‡ä»¶
          with open('CHANGELOG.txt', 'w', encoding='utf-8') as f:
              f.write(changelog)
          
          print('Changelog extracted successfully')
          "@
          
          if (Test-Path "CHANGELOG.txt") {
              echo "changelog_found=true" >> $env:GITHUB_OUTPUT
          } else {
              echo "changelog_found=false" >> $env:GITHUB_OUTPUT
          }
      
      - name: Generate version.json
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $buildDate = Get-Date -Format "yyyyMMdd"
          $fileSize = "${{ steps.filesize.outputs.size_mb }}"
          $tag = "${{ steps.version.outputs.tag }}"
          $repo = "${{ github.repository }}"
          
          # ä» CHANGELOG.txt è¯»å–æ›´æ–°æ—¥å¿—å¹¶è½¬æ¢ä¸º JSON æ•°ç»„
          $changelogItems = @()
          if (Test-Path "CHANGELOG.txt") {
              $changelog = Get-Content "CHANGELOG.txt" -Encoding UTF8
              $changelogItems = $changelog | Where-Object { $_ -match '^\s*[-*]' } | ForEach-Object {
                  $_ -replace '^\s*[-*]\s*', ''
              } | Select-Object -First 10
          }
          
          if ($changelogItems.Count -eq 0) {
              $changelogItems = @("è¯·æŸ¥çœ‹ Release é¡µé¢è·å–å®Œæ•´æ›´æ–°æ—¥å¿—")
          }
          
          # è½¬æ¢ä¸º JSON
          $changelogJson = $changelogItems | ConvertTo-Json -Compress
          
          # ç”Ÿæˆ version.json
          $versionJson = @"
          {
            "version": "$version",
            "build_date": "$buildDate",
            "download_url": "https://github.com/$repo/releases/download/$tag/æŸ¥è¯¢å·¥å…·.exe",
            "file_size_mb": $fileSize,
            "release_notes_url": "https://github.com/$repo/releases/tag/$tag",
            "min_version": "3.0.0",
            "changelog": $changelogJson
          }
          "@
          
          $versionJson | Set-Content "version.json" -Encoding UTF8
          
          Write-Host "Generated version.json:"
          Get-Content "version.json"
      
      - name: Generate Release Notes
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $buildDate = Get-Date -Format "yyyy-MM-dd"
          $fileSize = "${{ steps.filesize.outputs.size_mb }}"
          $tag = "${{ steps.version.outputs.tag }}"
          $repo = "${{ github.repository }}"
          
          # åˆ›å»º Release è¯´æ˜æ–‡ä»¶
          $releaseNotes = @"
          ## ğŸ‰ æŸ¥è¯¢å·¥å…· V$version
          
          **ç¼–è¯‘æ—¥æœŸ**: $buildDate
          **æ–‡ä»¶å¤§å°**: $fileSize MB
          
          ### ğŸ“¦ ä¸‹è½½
          - [æŸ¥è¯¢å·¥å…·.exe](https://github.com/$repo/releases/download/$tag/æŸ¥è¯¢å·¥å…·.exe)
          - [version.json](https://github.com/$repo/releases/download/$tag/version.json)
          
          ### ğŸ“ æ›´æ–°è¯´æ˜
          
          "@
          
          # æ·»åŠ ä» version.py æå–çš„æ›´æ–°æ—¥å¿—
          if (Test-Path "CHANGELOG.txt") {
              $changelog = Get-Content "CHANGELOG.txt" -Raw -Encoding UTF8
              $releaseNotes += $changelog
          } else {
              $releaseNotes += "è¯·æŸ¥çœ‹é¡¹ç›® README æˆ– query_tool/version.py ä¸­çš„ç‰ˆæœ¬å†å²ã€‚"
          }
          
          # æ·»åŠ ä½¿ç”¨è¯´æ˜
          $releaseNotes += @"
          
          
          ### ğŸš€ ä½¿ç”¨æ–¹æ³•
          1. ä¸‹è½½ ``æŸ¥è¯¢å·¥å…·.exe``
          2. ç›´æ¥è¿è¡Œï¼ˆæ— éœ€å®‰è£…ï¼‰
          3. é¦–æ¬¡è¿è¡Œè¯·é…ç½®è´¦å·ä¿¡æ¯
          
          ### ğŸ“š æ–‡æ¡£
          - [å¿«é€Ÿå¼€å§‹æŒ‡å—](https://github.com/$repo/blob/main/docs/quick-start.md)
          - [å®Œæ•´æ–‡æ¡£](https://github.com/$repo/blob/main/docs/README.md)
          
          ---
          *æ­¤ç‰ˆæœ¬ç”± GitHub Actions è‡ªåŠ¨æ„å»ºå’Œå‘å¸ƒ*
          "@
          
          $releaseNotes | Set-Content "RELEASE_NOTES.md" -Encoding UTF8
          
          Write-Host "Generated Release Notes:"
          Get-Content "RELEASE_NOTES.md"
      
      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/æŸ¥è¯¢å·¥å…·.exe
            version.json
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Commit version.json to repository
        shell: bash
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add version.json
          git commit -m "chore: update version.json for ${{ steps.version.outputs.tag }}" || echo "No changes to commit"
          git push origin HEAD:main || echo "Failed to push, but release is created"
